name: deploy-package
# Make it on push while testing
on:
  [push]
  # push:
  #   tags:
  #     - v*
jobs:
  deploy-windows:
    strategy:
      matrix:
        pyversion: ["3.8"] #["3.7", "3.8", "3.9"]
        target: [x64, x86]
    # ["ubuntu-latest", "windows-latest", "macos-latest"]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - name: Install latests stable Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.pyversion }}
      - name: Install packages
        run: pip install maturin
      - name: Deploy Package
        shell: bash
        env:
          PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
          PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run: maturin publish
          -u $PYPI_USERNAME
          -p $PYPI_PASSWORD
          -r https://test.pypi.org/simple
          --i python${{ matrix.pyversion }}
          -t ${{ matrix.target }}
          --skip-existing

  deploy-mac:
    strategy:
      matrix:
        pyversion: ["3.8"] #["3.7", "3.8", "3.9"]
    # ["ubuntu-latest", "windows-latest", "macos-latest"]
    runs-on: "macos-latest"
    steps:
      - uses: actions/checkout@v2
      - name: Install latests stable Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.pyversion }}
      - name: Install packages
        run: pip install maturin
      - name: Deploy Package
        shell: bash
        env:
          PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
          PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run:
          maturin publish
          -u $PYPI_USERNAME
          -p $PYPI_PASSWORD
          -r https://test.pypi.org/simple
          --i python${{ matrix.pyversion }}
          --skip-existing
          # -t x86_64
  deploy-manylinux:
    strategy:
      matrix:
        pyversion: ["3.8"] #["3.7", "3.8", "3.9"]
        target: [x86_64, i686]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install latests stable Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.pyversion }}
      - name: Setup Maturin Action
        uses: messense/maturin-action@v1
        env:
          PYPI_USERNAME: ${{ secrets.PYPI_USERNAME }}
          PYPI_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        with:
          maturin-version: latest
          target: ${{ matrix.target }}
          manylinux: auto
          command: publish
          args: -u $PYPI_USERNAME
            -p $PYPI_PASSWORD
            -r https://test.pypi.org/simple

            -i python${{matrix.pyversion}}
            --skip-existing
